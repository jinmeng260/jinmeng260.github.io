<!DOCTYPE html>
<html>

<head>
    <title>Rails Style Guide</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="Rails Style Guide, guide, rails,guide, Cheenwe" />
    <meta name="description" content="Rails Style Guide, guide, rails,guide, 序幕" />
    <meta name="theme-color" content="#2CA6CB"/>
    <link rel="shortcut icon" type="image/x-icon" media="screen" href="http://localhost:4000/favicon.ico" />
    <link rel="canonical" href="http://localhost:4000/2015-11-17/rails-style-guide/" />
    <link rel="alternate" type="application/rss+xml" title="Cheenwe" href="http://localhost:4000/feed.xml"  />

    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.bootcss.com/octicons/3.5.0/octicons.min.css" >
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/static/css/highlight.css" />
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/static/css/post.css" />
    
</head>


<body>
<div class="main">

  
  
  <header>
    <nav class="navbar navbar-tiffany rectangle" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://localhost:4000/">Cheenwe</a>
          <p class="navbar-text">A Ruby Coder</p>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            
            <li>
            <a href="http://localhost:4000/" class="word-keep"><span class="octicon octicon-book"></span></span>&nbsp;&nbsp;Blog</a>
            </li>
            
            
            <li>
              <a href="http://localhost:4000/archive/" class="word-keep"><span class="octicon octicon-repo"></span>&nbsp;&nbsp;Archive</a>
            </li>
            
            
            
            <li>
              <a href="http://localhost:4000/category/" class="word-keep"><span class="octicon octicon-list-unordered"></span>&nbsp;&nbsp;Category</a>
            </li>
            
            
            
            <li>
              <a href="http://localhost:4000/tags/" class="word-keep"><span class="octicon octicon-tag"></span>&nbsp;&nbsp;Tag</a>
            </li>
            
            
            
            
            
            <li>
              <a href="http://localhost:4000/project/" class="word-keep"><span class="octicon octicon-repo"></span>&nbsp;&nbsp;Project</a>
            </li>
            
            
            
            
            
            
            
            
            

            
<li>

  <a href="#stq=" class="search-button" data-toggle="modal" data-target="#myModal"><span class="octicon octicon-search">&nbsp;&nbsp; Search</span></a>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <form action="get" id="site_search">
            <input type="text" id="search_box" placeholder="Search">
            <button class="btn btn-default" type="submit"><span class="octicon octicon-search"></span></button>
          </form>
        </div>
        <div class="modal-body">
          <ul id="search_results"></ul>
        </div>
      </div>
    </div>
  </div>
</li>

          </ul>
        </div>
      </div>
    </nav>
  </header>



    <div class="container">
        <div class="row">
    <div class="content col-lg-9">
        <div class="sheet post">
          <header>
            <h2>Rails Style Guide</h2>
            <p class="post-meta">
                <span class="octicon octicon-clock"></span> Nov 17, 2015
            </p>
            <p class="post-tag">
                <span><a href="http://localhost:4000/category/#guide"><span class="octicon octicon-list-unordered"></span>&nbsp;guide</a></span>
                <span>
                    <a class="word-keep" href="http://localhost:4000/tags/#rails"><span class="octicon octicon-tag"></span>&nbsp;rails</a>
                    
                    <a class="word-keep" href="http://localhost:4000/tags/#guide"><span class="octicon octicon-tag"></span>&nbsp;guide</a>
                    
                </span>
            </p>
          </header>
          <hr class="boundary">
          <article>
            <h1 id="序幕">序幕</h1>

<p>https://github.com/JuanitoFatas/rails-style-guide/blob/master/README-zhCN.md</p>

<blockquote>
  <p>Role models are important. <br />
– 机械战警 Alex J. Murphy</p>
</blockquote>

<p>这份指南目的于演示一整套 Rails 3 开发的风格惯例及最佳实践。这是一份与由现存社群所驱动的<a href="https://github.com/bbatsov/ruby-style-guide">Ruby 编码风格指南</a>互补的指南。</p>

<p>而本指南中<a href="#testing">测试 Rails 应用</a>小节摆在<a href="#developing">开发 Rails 应用</a>之后，因为我相信<a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development">行为驱动开发</a>
(BDD) 是最佳的软体开发之道。铭记在心吧。</p>

<p>Rails 是一个坚持己见的框架，而这也是一份坚持己见的指南。在我的心里，我坚信 <a href="https://www.relishapp.com/rspec">RSpec</a> 优于 Test::Unit，<a href="http://sass-lang.com/">Sass</a> 优于 CSS 以及
<a href="http://haml-lang.com/">Haml</a>，(<a href="http://slim-lang.com/">Slim</a>) 优于 Erb。所以不要期望在这里找到 Test::Unit, CSS 及 Erb 的忠告。</p>

<p>某些忠告仅适用于 Rails 3.1+ 以上版本。</p>

<p>你可以使用 <a href="https://github.com/TechnoGate/transmuter">Transmuter</a> 来产生本指南的一份 PDF 或 HTML 复本。</p>

<h1 id="目录">目录</h1>

<ul>
  <li><a href="#-rails-">开发 Rails 应用程序</a>
    <ul>
      <li><a href="#-2">配置</a></li>
      <li><a href="#-3">路由</a></li>
      <li><a href="#-4">控制器</a></li>
      <li><a href="#-5">模型</a></li>
      <li><a href="#-6">迁移</a></li>
      <li><a href="#-7">视图</a></li>
      <li><a href="#-8">国际化</a></li>
      <li><a href="#assets">Assets</a></li>
      <li><a href="#mailers">Mailers</a></li>
      <li><a href="#bundler">Bundler</a></li>
      <li><a href="#-gems">无价的 Gems</a></li>
      <li><a href="#-gems-1">缺陷的 Gems</a></li>
      <li><a href="#-9">管理进程</a></li>
    </ul>
  </li>
  <li><a href="#-rails--1">测试 Rails 应用</a>
    <ul>
      <li><a href="#cucumber">Cucumber</a></li>
      <li><a href="#rspec">RSpec</a></li>
    </ul>
  </li>
</ul>

<p>本指南被翻译成下列语言：</p>

<ul>
  <li><a href="https://github.com/JuanitoFatas/rails-style-guide/blob/master/README.md">英文原版</a></li>
  <li><a href="https://github.com/JuanitoFatas/rails-style-guide/blob/master/README-zhTW.md">繁體中文</a></li>
</ul>

<h1 id="开发-rails-应用程序">开发 Rails 应用程序</h1>

<h2 id="配置">配置</h2>

<ul>
  <li>把惯用的初始化代码放在 <code class="highlighter-rouge">config/initializers</code>。 在 initializers 内的代码于应用启动时执行。</li>
  <li>每一个 gem 相关的初始化代码应当使用同样的名称，放在不同的文件里，如： <code class="highlighter-rouge">carrierwave.rb</code>, <code class="highlighter-rouge">active_admin.rb</code>, 等等。</li>
  <li>相应调整配置开发、测试及生产环境（在 <code class="highlighter-rouge">config/environments/</code> 下对应的文件）
    <ul>
      <li>
        <p>添加需要预编译的额外静态资源文件（如果有的话）：</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
# config/environments/production.rb
# 预编译额外的静态资源文件(application.js, application.css, 以及所有已经被加入的非 JS 或 CSS 的文件)
config.assets.precompile += %w( rails_admin/rails_admin.css rails_admin/rails_admin.js )
```
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>将所有环境皆通用的配置档放在 <code class="highlighter-rouge">config/application.rb</code> 文件。</li>
  <li>构建一个与生产环境(production enviroment)相似的，一个额外的 <code class="highlighter-rouge">staging</code> 环境。</li>
</ul>

<h2 id="路由">路由</h2>

<ul>
  <li>
    <p>当你需要加入一个或多个动作至一个 RESTful 资源时（你真的需要吗？），使用 <code class="highlighter-rouge">member</code> and <code class="highlighter-rouge">collection</code> 路由。</p>

    <pre><code class="language-Ruby">  # 差
  get 'subscriptions/:id/unsubscribe'
  resources :subscriptions

  # 好
  resources :subscriptions do
    get 'unsubscribe', on: :member
  end

  # 差
  get 'photos/search'
  resources :photos

  # 好
  resources :photos do
    get 'search', on: :collection
  end
</code></pre>
  </li>
  <li>
    <p>若你需要定义多个 <code class="highlighter-rouge">member/collection</code> 路由时，使用替代的区块语法(block syntax)。</p>

    <pre><code class="language-Ruby">  resources :subscriptions do
    member do
      get 'unsubscribe'
      # 更多路由
    end
  end

  resources :photos do
    collection do
      get 'search'
      # 更多路由
    end
  end
</code></pre>
  </li>
  <li>
    <p>使用嵌套路由(nested routes)来更佳地表达与 ActiveRecord 模型的关系。</p>

    <pre><code class="language-Ruby">  class Post &lt; ActiveRecord::Base
    has_many :comments
  end

  class Comments &lt; ActiveRecord::Base
    belongs_to :post
  end

  # routes.rb
  resources :posts do
    resources :comments
  end
</code></pre>
  </li>
  <li>
    <p>使用命名空间路由来群组相关的行为。</p>

    <pre><code class="language-Ruby">  namespace :admin do
    # Directs /admin/products/* to Admin::ProductsController
    # (app/controllers/admin/products_controller.rb)
    resources :products
  end
</code></pre>
  </li>
  <li>
    <p>不要在控制器里使用留给后人般的疯狂路由(legacy wild controller route)。这种路由会让每个控制器的动作透过 GET 请求存取。</p>

    <pre><code class="language-Ruby">  # 非常差
  match ':controller(/:action(/:id(.:format)))'
</code></pre>
  </li>
</ul>

<h2 id="控制器">控制器</h2>

<ul>
  <li>让你的控制器保持苗条 ― 它们应该只替视图层取出数据且不包含任何业务逻辑（所有业务逻辑应当放在模型里）。</li>
  <li>每个控制器的行动应当（理想上）只调用一个除了初始的 find 或 new 方法。</li>
  <li>控制器与视图之间共享不超过两个实例变量(instance variable)。</li>
</ul>

<h2 id="模型">模型</h2>

<ul>
  <li>自由地引入不是 ActiveRecord 的类别吧。</li>
  <li>替模型命名有意义（但简短）且不带缩写的名字。</li>
  <li>
    <p>如果你需要模型有著 ActiveRecord 行为的对象，比方说验证这一块，使用 <a href="https://github.com/cgriego/active_attr">ActiveAttr</a> gem。</p>

    <pre><code class="language-Ruby">  class Message
    include ActiveAttr::Model

    attribute :name
    attribute :email
    attribute :content
    attribute :priority

    attr_accessible :name, :email, :content

    validates_presence_of :name
    validates_format_of :email, :with =&gt; /\A[-a-z0-9_+\.]+\@([-a-z0-9]+\.)+[a-z0-9]{2,4}\z/i
    validates_length_of :content, :maximum =&gt; 500
  end
</code></pre>

    <p>更完整的示例，参考 <a href="http://railscasts.com/episodes/326-activeattr">RailsCast on the subject</a>。</p>
  </li>
</ul>

<h3 id="activerecord">ActiveRecord</h3>

<ul>
  <li>避免改动缺省的 ActiveRecord（表的名字、主键，等等），除非你有一个非常好的理由（像是不受你控制的数据库）。</li>
  <li>
    <p>把宏风格的方法（<code class="highlighter-rouge">has_many</code>, <code class="highlighter-rouge">validates</code>, 等等）放在类别定义的前面。</p>

    <pre><code class="language-Ruby">  class User &lt; ActiveRecord::Base
    # 默认的scope放在最前面(如果有)
    default_scope { where(active: true) }

    # 接下来是常量
    GENDERS = %w(male female)

    # 然后放一些attr相关的宏
    attr_accessor :formatted_date_of_birth

    attr_accessible :login, :first_name, :last_name, :email, :password

    # 仅接着是关联的宏
    belongs_to :country

    has_many :authentications, dependent: :destroy

    # 以及宏的验证
    validates :email, presence: true
    validates :username, presence: true
    validates :username, uniqueness: { case_sensitive: false }
    validates :username, format: { with: /\A[A-Za-z][A-Za-z0-9._-]{2,19}\z/ }
    validates :password, format: { with: /\A\S{8,128}\z/, allow_nil: true}

    # 接着是回调
    before_save :cook
    before_save :update_username_lower

    # 其它的宏 (像devise的) 应该放在回调的后面

    ...
  end
</code></pre>
  </li>
  <li>
    <p>偏好 <code class="highlighter-rouge">has_many :through</code> 胜于 <code class="highlighter-rouge">has_and_belongs_to_many</code>。 使用 <code class="highlighter-rouge">has_many :through</code> 允许在 join 模型有附加的属性及验证</p>

    <pre><code class="language-Ruby">  # 使用 has_and_belongs_to_many
  class User &lt; ActiveRecord::Base
    has_and_belongs_to_many :groups
  end

  class Group &lt; ActiveRecord::Base
    has_and_belongs_to_many :users
  end

  # 偏好方式 - using has_many :through
  class User &lt; ActiveRecord::Base
    has_many :memberships
    has_many :groups, through: :memberships
  end

  class Membership &lt; ActiveRecord::Base
    belongs_to :user
    belongs_to :group
  end

  class Group &lt; ActiveRecord::Base
    has_many :memberships
    has_many :users, through: :memberships
  end
</code></pre>
  </li>
  <li>使用新的 <a href="http://thelucid.com/2010/01/08/sexy-validation-in-edge-rails-rails-3/">“sexy” validation</a>。</li>
  <li>
    <p>当一个惯用的验证使用超过一次或验证是某个正则表达映射时，创建一个惯用的 validator 文件。</p>

    <pre><code class="language-Ruby">  # 差
  class Person
    validates :email, format: { with: /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i }
  end

  # 好
  class EmailValidator &lt; ActiveModel::EachValidator
    def validate_each(record, attribute, value)
      record.errors[attribute] &lt;&lt; (options[:message] || 'is not a valid email') unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i
    end
  end

  class Person
    validates :email, email: true
  end
</code></pre>
  </li>
  <li>所有惯用的验证器应放在一个共享的 gem 。</li>
  <li>
    <p>自由地使用命名的作用域(scope)。</p>

    <pre><code class="language-Ruby">  class User &lt; ActiveRecord::Base
    scope :active, -&gt; { where(active: true) }
    scope :inactive, -&gt; { where(active: false) }

    scope :with_orders, -&gt; { joins(:orders).select('distinct(users.id)') }
  end
</code></pre>
  </li>
  <li>
    <p>将命名的作用域包在 <code class="highlighter-rouge">lambda</code> 里来惰性地初始化。</p>

    <pre><code class="language-Ruby">  # 差劲
  class User &lt; ActiveRecord::Base
    scope :active, where(active: true)
    scope :inactive, where(active: false)

    scope :with_orders, joins(:orders).select('distinct(users.id)')
  end

  # 好
  class User &lt; ActiveRecord::Base
    scope :active, -&gt; { where(active: true) }
    scope :inactive, -&gt; { where(active: false) }

    scope :with_orders, -&gt; { joins(:orders).select('distinct(users.id)') }
  end
</code></pre>
  </li>
  <li>
    <p>当一个由 lambda 及参数定义的作用域变得过于复杂时，更好的方式是建一个作为同样用途的类别方法，并返回一个 <code class="highlighter-rouge">ActiveRecord::Relation</code> 对象。你也可以这么定义出更精简的作用域。</p>

    <pre><code class="language-Ruby">  class User &lt; ActiveRecord::Base
    def self.with_orders
      joins(:orders).select('distinct(users.id)')
    end
  end
</code></pre>
  </li>
  <li>注意 <code class="highlighter-rouge">update_attribute</code> 方法的行为。它不运行模型验证（不同于 <code class="highlighter-rouge">update_attributes</code> ）并且可能把模型状态给搞砸。</li>
  <li>使用用户友好的网址。在网址显示具描述性的模型属性，而不只是 <code class="highlighter-rouge">id</code> 。
有不止一种方法可以达成：
    <ul>
      <li>
        <p>覆写模型的 <code class="highlighter-rouge">to_param</code> 方法。这是 Rails 用来给对象建构网址的方法。缺省的实作会以字串形式返回该 <code class="highlighter-rouge">id</code> 的记录。它可被另一个具人类可读的属性覆写。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
class Person
  def to_param
    "#{id} #{name}".parameterize
  end
end
```
</code></pre></div>        </div>

        <p>为了要转换成对网址友好 (URL-friendly)的数值，字串应当调用 <code class="highlighter-rouge">parameterize</code> 。 对象的 <code class="highlighter-rouge">id</code> 要放在开头，以便给 ActiveRecord 的 <code class="highlighter-rouge">find</code> 方法查找。</p>
      </li>
      <li>
        <p>使用此 <code class="highlighter-rouge">friendly_id</code> gem。它允许藉由某些具描述性的模型属性，而不是用 <code class="highlighter-rouge">id</code> 来创建人类可读的网址。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
class Person
  extend FriendlyId
  friendly_id :name, use: :slugged
end
```

查看 [gem 文档](https://github.com/norman/friendly_id)获得更多关于使用的信息。
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="activeresource">ActiveResource</h3>

<ul>
  <li>
    <p>当 HTTP 响应是一个与存在的格式不同的格式时（XML 和 JSON），需要某些额外的格式解析，创一个你惯用的格式，并在类别中使用它。惯用的格式应当实作下列方法：<code class="highlighter-rouge">extension</code>, <code class="highlighter-rouge">mime_type</code>,
<code class="highlighter-rouge">encode</code> 以及 <code class="highlighter-rouge">decode</code>。</p>

    <pre><code class="language-Ruby">  module ActiveResource
    module Formats
      module Extend
        module CSVFormat
          extend self

          def extension
            'csv'
          end

          def mime_type
            'text/csv'
          end

          def encode(hash, options = nil)
            # 数据以新格式编码并返回
          end

          def decode(csv)
            # 数据以新格式解码并返回
          end
        end
      end
    end
  end

  class User &lt; ActiveResource::Base
    self.format = ActiveResource::Formats::Extend::CSVFormat

    ...
  end
</code></pre>
  </li>
  <li>
    <p>若 HTTP 请求应当不扩展发送时，覆写 <code class="highlighter-rouge">ActiveResource::Base</code> 的 <code class="highlighter-rouge">element_path</code> 及 <code class="highlighter-rouge">collection_path</code> 方法，并移除扩展的部份。</p>

    <pre><code class="language-Ruby">  class User &lt; ActiveResource::Base
    ...

    def self.collection_path(prefix_options = {}, query_options = nil)
      prefix_options, query_options = split_options(prefix_options) if query_options.nil?
      "#{prefix(prefix_options)}#{collection_name}#{query_string(query_options)}"
    end

    def self.element_path(id, prefix_options = {}, query_options = nil)
      prefix_options, query_options = split_options(prefix_options) if query_options.nil?
      "#{prefix(prefix_options)}#{collection_name}/#{URI.parser.escape id.to_s}#{query_string(query_options)}"
    end
  end
</code></pre>

    <p>如有任何改动网址的需求时，这些方法也可以被覆写。</p>
  </li>
</ul>

<h2 id="迁移">迁移</h2>

<ul>
  <li>把 <code class="highlighter-rouge">schema.rb</code> 保存在版本管控之下。</li>
  <li>使用 <code class="highlighter-rouge">rake db:scheme:load</code> 取代 <code class="highlighter-rouge">rake db:migrate</code> 来初始化空的数据库。</li>
  <li>使用 <code class="highlighter-rouge">rake db:test:prepare</code> 来更新测试数据库的 schema。</li>
  <li>
    <p>避免在表里设置缺省数据。使用模型层来取代。</p>

    <pre><code class="language-Ruby">  def amount
    self[:amount] or 0
  end
</code></pre>

    <p>然而 <code class="highlighter-rouge">self[:attr_name]</code> 的使用被视为相当常见的，你也可以考虑使用更罗嗦的（争议地可读性更高的） <code class="highlighter-rouge">read_attribute</code> 来取代：</p>

    <pre><code class="language-Ruby">  def amount
    read_attribute(:amount) or 0
  end
</code></pre>
  </li>
  <li>
    <p>当编写建设性的迁移时（加入表或栏位），使用 Rails 3.1 的新方式来迁移 - 使用 <code class="highlighter-rouge">change</code> 方法取代 <code class="highlighter-rouge">up</code> 与 <code class="highlighter-rouge">down</code> 方法。</p>

    <pre><code class="language-Ruby">  # 过去的方式
  class AddNameToPerson &lt; ActiveRecord::Migration
    def up
      add_column :persons, :name, :string
    end

    def down
      remove_column :person, :name
    end
  end

  # 新的偏好方式
  class AddNameToPerson &lt; ActiveRecord::Migration
    def change
      add_column :persons, :name, :string
    end
  end
</code></pre>
  </li>
</ul>

<h2 id="视图">视图</h2>

<ul>
  <li>不要直接从视图调用模型层。</li>
  <li>不要在视图构造复杂的格式，把它们输出到视图 helper 的一个方法或是模型。</li>
  <li>使用 partial 模版与布局来减少重复的代码。</li>
  <li>加入 <a href="https://github.com/bcardarella/client_side_validations">client side validation</a> 至惯用的 validators。 要做的步骤有：
    <ul>
      <li>
        <p>声明一个由 <code class="highlighter-rouge">ClientSideValidations::Middleware::Base</code> 而来的自定 validator</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
module ClientSideValidations::Middleware
  class Email &lt; Base
    def response
      if request.params[:email] =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i
        self.status = 200
      else
        self.status = 404
      end
      super
    end
  end
end
```
</code></pre></div>        </div>
      </li>
      <li>
        <p>建立一个新文件
<code class="highlighter-rouge">public/javascripts/rails.validations.custom.js.coffee</code> 并在你的 <code class="highlighter-rouge">application.js.coffee</code> 文件加入一个它的参照：</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
# app/assets/javascripts/application.js.coffee
#= require rails.validations.custom
```
</code></pre></div>        </div>
      </li>
      <li>
        <p>添加你的用户端 validator：</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
#public/javascripts/rails.validations.custom.js.coffee
clientSideValidations.validators.remote['email'] = (element, options) -&gt;
  if $.ajax({
    url: '/validators/email.json',
    data: { email: element.val() },
    async: false
  }).status == 404
    return options.message || 'invalid e-mail format'
```
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h2 id="国际化">国际化</h2>

<ul>
  <li>视图、模型与控制器里不应使用语言相关设置与字串。这些文字应搬到在 <code class="highlighter-rouge">config/locales</code> 下的语言文件里。</li>
  <li>
    <p>当 ActiveRecord 模型的标签需要被翻译时，使用<code class="highlighter-rouge">activerecord</code> 作用域:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  en:
    activerecord:
      models:
        user: Member
      attributes:
        user:
          name: "Full name"
</code></pre></div>    </div>

    <p>然后 <code class="highlighter-rouge">User.model_name.human</code> 会返回 “Member” ，而 <code class="highlighter-rouge">User.human_attribute_name("name")</code> 会返回 “Full name”。这些属性的翻译会被视图作为标签使用。</p>
  </li>
  <li>把在视图使用的文字与 ActiveRecord 的属性翻译分开。 把给模型使用的语言文件放在名为 <code class="highlighter-rouge">models</code> 的文件夹，给视图使用的文字放在名为 <code class="highlighter-rouge">views</code> 的文件夹。
    <ul>
      <li>
        <p>当使用额外目录的语言文件组织完成时，为了要载入这些目录，要在 <code class="highlighter-rouge">application.rb</code> 文件里描述这些目录。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
# config/application.rb
config.i18n.load_path += Dir[Rails.root.join('config', 'locales', '**', '*.{rb,yml}')]
```
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>把共享的本土化选项，像是日期或货币格式，放在 <code class="highlighter-rouge">locales</code> 的根目录下。</li>
  <li>使用精简形式的 I18n 方法： <code class="highlighter-rouge">I18n.t</code> 来取代 <code class="highlighter-rouge">I18n.translate</code> 以及使用 <code class="highlighter-rouge">I18n.l</code> 取代 <code class="highlighter-rouge">I18n.localize</code>。</li>
  <li>
    <p>使用 “懒惰” 查询视图中使用的文字。假设我们有以下结构：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  en:
    users:
      show:
        title: "User details page"
</code></pre></div>    </div>

    <p><code class="highlighter-rouge">users.show.title</code> 的数值能这样被 <code class="highlighter-rouge">app/views/users/show.html.haml</code> 查询：</p>

    <pre><code class="language-Ruby">  = t '.title'
</code></pre>
  </li>
  <li>
    <p>在控制器与模型使用点分隔的键，来取代指定 <code class="highlighter-rouge">:scope</code> 选项。点分隔的调用更容易阅读及追踪层级。</p>

    <pre><code class="language-Ruby">  # 这样子调用
  I18n.t 'activerecord.errors.messages.record_invalid'

  # 而不是这样
  I18n.t :record_invalid, :scope =&gt; [:activerecord, :errors, :messages]
</code></pre>
  </li>
  <li>关于 Rails i18n 更详细的信息可以在这里找到 <a href="http://guides.rubyonrails.org/i18n.html">Rails Guides</a>。</li>
</ul>

<h2 id="assets">Assets</h2>

<p>利用这个 <a href="http://guides.rubyonrails.org/asset_pipeline.html">assets pipeline</a> 来管理应用的结构。</p>

<ul>
  <li>保留 <code class="highlighter-rouge">app/assets</code> 给自定的样式表，Javascripts 或图片。</li>
  <li>把自己开发，但不适合用在这个应用的函式库，放在 <code class="highlighter-rouge">lib/assets/</code>。</li>
  <li>第三方代码如： <a href="http://jquery.com/">jQuery</a> 或 <a href="http://twitter.github.com/bootstrap/">bootstrap</a> 应放置在 <code class="highlighter-rouge">vendor/assets</code>。</li>
  <li>当可能的时候，使用 gem 化的 assets 版本。(如： <a href="https://github.com/rails/jquery-rails">jquery-rails</a>)。</li>
</ul>

<h2 id="mailers">Mailers</h2>

<ul>
  <li>把 mails 命名为 <code class="highlighter-rouge">SomethingMailer</code>。 没有 Mailer 字根的话，不能立即显现哪个是一个 Mailer，以及哪个视图与它有关。</li>
  <li>提供 HTML 与纯文本视图模版。</li>
  <li>
    <p>在你的开发环境启用信件失败发送错误。这些错误缺省是被停用的。</p>

    <pre><code class="language-Ruby">  # config/environments/development.rb

  config.action_mailer.raise_delivery_errors = true
</code></pre>
  </li>
  <li>
    <p>在开发模式使用 <code class="highlighter-rouge">smtp.gmail.com</code> 设置 SMTP 服务器（当然了，除非你自己有本地 SMTP 服务器）。</p>

    <pre><code class="language-Ruby">  # config/environments/development.rb

  config.action_mailer.smtp_settings = {
    address: 'smtp.gmail.com',
    # 更多设置
  }
</code></pre>
  </li>
  <li>
    <p>提供缺省的配置给主机名。</p>

    <pre><code class="language-Ruby">  # config/environments/development.rb
  config.action_mailer.default_url_options = {host: "#{local_ip}:3000"}


  # config/environments/production.rb
  config.action_mailer.default_url_options = {host: 'your_site.com'}

  # 在你的 mailer 类
  default_url_options[:host] = 'your_site.com'
</code></pre>
  </li>
  <li>
    <p>如果你需要在你的网站使用一个 email 链结，总是使用 <code class="highlighter-rouge">_url</code> 方法，而不是 <code class="highlighter-rouge">_path</code> 方法。 <code class="highlighter-rouge">_url</code> 方法包含了主机名，而 <code class="highlighter-rouge">_path</code> 方法没有。</p>

    <pre><code class="language-Ruby">  # 错误
  You can always find more info about this course
  = link_to 'here', url_for(course_path(@course))

  # 正确
  You can always find more info about this course
  = link_to 'here', url_for(course_url(@course))
</code></pre>
  </li>
  <li>
    <p>正确地显示寄与收件人地址的格式。使用下列格式：</p>

    <pre><code class="language-Ruby">  # 在你的 mailer 类别
  default from: 'Your Name &lt;info@your_site.com&gt;'
</code></pre>
  </li>
  <li>
    <p>确定测试环境的 email 发送方法设置为 <code class="highlighter-rouge">test</code> ：</p>

    <pre><code class="language-Ruby">  # config/environments/test.rb

  config.action_mailer.delivery_method = :test
</code></pre>
  </li>
  <li>
    <p>开发与生产环境的发送方法应为 <code class="highlighter-rouge">smtp</code> ：</p>

    <pre><code class="language-Ruby">  # config/environments/development.rb, config/environments/production.rb

  config.action_mailer.delivery_method = :smtp
</code></pre>
  </li>
  <li>
    <p>当发送 HTML email 时，所有样式应为行内样式，由于某些用户有关于外部样式的问题。某种程度上这使得更难管理及造成代码重用。有两个相似的 gem 可以转换样式，以及将它们放在对应的 html 标签里： <a href="https://github.com/fphilipe/premailer-rails3">premailer-rails3</a> 和 <a href="https://github.com/Mange/roadie">roadie</a>。</p>
  </li>
  <li>应避免页面产生响应时寄送 email。若多个 email 寄送时，造成了页面载入延迟，以及请求可能逾时。使用 <a href="https://github.com/tobi/delayed_job">delayed_job</a> gem 的帮助来克服在背景处理寄送 email 的问题。</li>
</ul>

<h2 id="bundler">Bundler</h2>

<ul>
  <li>把只给开发环境或测试环境的 gem 适当地分组放在 Gemfile 文件中。</li>
  <li>在你的项目中只使用公认的 gem。 如果你考虑引入某些鲜为人所知的 gem ，你应该先仔细复查一下它的源代码。</li>
  <li>
    <p>关于多个开发者使用不同操作系统的项目，操作系统相关的 gem 缺省会产生一个经常变动的 <code class="highlighter-rouge">Gemfile.lock</code> 。 在 Gemfile 文件里，所有与 OS X 相关的 gem 放在 <code class="highlighter-rouge">darwin</code> 群组，而所有 Linux 相关的 gem 放在 <code class="highlighter-rouge">linux</code> 群组：</p>

    <pre><code class="language-Ruby">  # Gemfile
  group :darwin do
    gem 'rb-fsevent'
    gem 'growl'
  end

  group :linux do
    gem 'rb-inotify'
  end
</code></pre>

    <p>要在对的环境获得合适的 gem，添加以下代码至 <code class="highlighter-rouge">config/application.rb</code> ：</p>

    <pre><code class="language-Ruby">  platform = RUBY_PLATFORM.match(/(linux|darwin)/)[0].to_sym
  Bundler.require(platform)
</code></pre>
  </li>
  <li>不要把 <code class="highlighter-rouge">Gemfile.lock</code> 文件从版本控制里移除。这不是随机产生的文件 - 它确保你所有的组员执行 <code class="highlighter-rouge">bundle install</code> 时，获得相同版本的 gem 。</li>
</ul>

<h2 id="无价的-gems">无价的 Gems</h2>

<p>一个最重要的编程理念是 “不要重造轮子！” 。若你遇到一个特定问题，你应该要在你开始前，看一下是否有存在的解决方案。下面是一些在很多 Rails 项目中 “无价的” gem 列表（全部兼容 Rails 3.1）：</p>

<ul>
  <li><a href="https://github.com/gregbell/active_admin">active_admin</a> - 有了 ActiveAdmin，创建 Rails 应用的管理界面就像儿戏。你会有一个很好的仪表盘，图形化 CRUD 界面以及更多东西。非常灵活且可客制化。</li>
  <li><a href="https://github.com/charliesome/better_errors">better_errors</a> - Better Errors 用更好更有效的错误页面，取代了 Rails 标准的错误页面。不仅可用在 Rails，任何将 Rack 当作中间件的 app 都可使用。</li>
  <li><a href="https://github.com/flyerhzm/bullet">bullet</a> - Bullet 就是为了帮助提升应用的效能（通过减少查询）而打造的 gem。会在你开发应用时，替你注意你的查询，并在需要 eager loading (N+1 查询)时、或是你在不必要的情况使用 eager loading 时，或是在应该要使用 counter cache 时，都会提醒你。</li>
  <li><a href="https://github.com/ryanb/cancan">cancan</a> - CanCan 是一个权限管理的 gem，
让你可以管制用户可存取的支援。所有的授权都定义在一个档案里（ability.rb），并提供许多方便的方法，让你检查及确保整个应用内权限是否是可得的。</li>
  <li><a href="https://github.com/jnicklas/capybara">capybara</a> - Capybara 旨在简化整合测试 Rack 应用的过程，像是 Rails、Sinatra 或 Merb。Capybara 模拟了真实用户使用 web 应用的互动。 它与你测试在运行的驱动无关，并原生搭载 Rack::Test 及 Selenium 支持。透过外部 gem 支持 HtmlUnit、WebKit 及 env.js 。与 RSpec &amp; Cucumber 一起使用时工作良好。</li>
  <li><a href="https://github.com/jnicklas/carrierwave">carrierwave</a> - Rails 最后一个文件上传解决方案。支持上传档案（及很多其它的酷玩意儿的）的本地储存与云储存。图片后处理与 ImageMagick 整合得非常好。</li>
  <li><a href="https://github.com/bcardarella/client_side_validations">client_side_validations</a> -
一个美妙的 gem，替你从现有的服务器端模型验证自动产生 Javascript 用户端验证。高度推荐！</li>
  <li><a href="https://github.com/chriseppstein/compass">compass-rails</a> - 一个优秀的 gem，添加了某些 css 框架的支持。包括了 sass mixin 的蒐集，让你减少 css 文件的代码并帮你解决浏览器兼容问题。</li>
  <li><a href="https://github.com/cucumber/cucumber-rails">cucumber-rails</a> - Cucumber 是一个由 Ruby 所写，开发功能测试的顶级工具。 cucumber-rails 提供了 Cucumber 的 Rails 整合。</li>
  <li><a href="https://github.com/plataformatec/devise">devise</a> - Devise 是 Rails 应用的一个完整解决方案。多数情况偏好使用 devise 来开始你的客制验证方案。</li>
  <li><a href="http://fabricationgem.org/">fabrication</a> - 一个很好的假数据产生器（编辑者的选择）。</li>
  <li><a href="https://github.com/thoughtbot/factory_girl">factory_girl</a> - 另一个 Fabrication 的选择。一个成熟的假数据产生器。 Fabrication 的精神领袖先驱。</li>
  <li><a href="https://github.com/EmmanuelOga/ffaker">ffaker</a> - 实用的 gem 来产生仿造的数据（名字、地址，等等）。</li>
  <li><a href="https://github.com/pauldix/feedzirra">feedzirra</a> - 非常快速及灵活的 RSS 或 Atom 种子解析器。</li>
  <li><a href="https://github.com/norman/friendly_id">friendly_id</a> - 透过使用某些具描述性的模型属性，而不是使用 id，允许你创建人类可读的网址。</li>
  <li><a href="https://github.com/svenfuchs/globalize3.git">globalize3</a> - Globalize3 是 Globalize 的后继者，针对 ActiveRecord 3.x 设计。基于新的 I18n API 打造而成，并帮 ActiveRecord 模型添加了事务功能。</li>
  <li><a href="https://github.com/guard/guard">guard</a> - 极佳的 gem 监控文件变化及任务的调用。搭载了很多实用的扩充。远优于 autotest 与 <a href="https://github.com/mynyml/watchr">watchr</a>。</li>
  <li><a href="https://github.com/indirect/haml-rails">haml-rails</a> - haml-rails 提供了 Haml 的 Rails 整合。</li>
  <li><a href="http://haml-lang.com">haml</a> - Haml 是一个简洁的模型语言，被很多人认为（包括我）远优于 Erb。</li>
  <li><a href="https://github.com/amatsuda/kaminari">kaminari</a> - 很棒的分页解决方案。</li>
  <li><a href="https://github.com/notahat/machinist">machinist</a> - 假数据不好玩，Machinist 才好玩。</li>
  <li><a href="https://github.com/rspec/rspec-rails">rspec-rails</a> - RSpec 是 Test::MiniTest 的取代者。我不高度推荐 RSpec。 rspec-rails 提供了 RSpec 的 Rails 整合。</li>
  <li><a href="https://github.com/plataformatec/simple_form">simple_form</a> - 一旦用过 simple_form（或 formatastic），你就不想听到关于 Rails 缺省的表单。它是一个创造表单很棒的DSL。</li>
  <li><a href="https://github.com/fguillen/simplecov-rcov">simplecov-rcov</a> - 为了 SimpleCov 打造的 RCov formatter。若你想使用 SimpleCov 搭配 Hudson 持续整合服务器，很有用。</li>
  <li><a href="https://github.com/colszowka/simplecov">simplecov</a> - 代码覆盖率工具。不像 RCov，完全兼容 Ruby 1.9。产生精美的报告。必须用！</li>
  <li><a href="http://slim-lang.com">slim</a> - Slim 是一个简洁的模版语言，被视为是远远优于 HAML(Erb 就更不用说了)的语言。唯一会阻止我大规模地使用它的是，主流 IDE 及编辑器对它的支持不好。但它的效能是非凡的。</li>
  <li><a href="https://github.com/sporkrb/spork">spork</a> - 一个给测试框架（RSpec 或 现今 Cucumber）用的 DRb 服务器，每次运行前确保分支出一个乾净的测试状态。 简单的说，预载很多测试环境的结果是大幅降低你的测试启动时间，绝对必须用！</li>
  <li><a href="https://github.com/sunspot/sunspot">sunspot</a> - 基于 SOLR 的全文检索引擎。</li>
</ul>

<p>这不是完整的清单，以及其它的 gem 也可以在之后加进来。以上清单上的所有 gems 皆经测试，处于活跃开发阶段，有社群以及代码的质量很高。</p>

<h2 id="缺陷的-gems">缺陷的 Gems</h2>

<p>这是一个有问题的或被别的 gem 取代的 gem 清单。你应该在你的项目里避免使用它们。</p>

<ul>
  <li><a href="http://rmagick.rubyforge.org/">rmagick</a> - 这个 gem 因大量消耗内存而声名狼藉。使用 <a href="https://github.com/probablycorey/mini_magick">minimagick</a> 来取代。</li>
  <li><a href="http://www.zenspider.com/ZSS/Products/ZenTest/">autotest</a> - 自动测试的老旧解决方案。远不如 guard 及 <a href="https://github.com/mynyml/watchr">watchr</a>。</li>
  <li><a href="https://github.com/relevance/rcov">rcov</a> - 代码覆盖率工具，不兼容 Ruby 1.9。使用 <a href="https://github.com/colszowka/simplecov">SimpleCov</a> 来取代。</li>
  <li><a href="https://github.com/cowboyd/therubyracer">therubyracer</a> - 极度不鼓励在生产模式使用这个 gem，它消耗大量的内存。我会推荐使用 <code class="highlighter-rouge">node.js</code> 来取代。</li>
</ul>

<p>这仍是一个完善中的清单。请告诉我受人欢迎但有缺陷的 gems 。</p>

<h2 id="管理进程">管理进程</h2>

<ul>
  <li>若你的项目依赖各种外部的进程使用 <a href="https://github.com/ddollar/foreman">foreman</a> 来管理它们。</li>
</ul>

<h1 id="测试-rails-应用">测试 Rails 应用</h1>

<p>也许 BDD 方法是实作一个新功能最好的方法。你从开始写一些高阶的测试（通常使用 Cucumber），然后使用这些测试来驱使你实作功能。一开始你给功能的视图写测试，并使用这些测试来创建相关的视图。之后，你创建丢给视图数据的控制器测试来实现控制器。最后你实作模型的测试以及模型自身。</p>

<h2 id="cucumber">Cucumber</h2>

<ul>
  <li>用 <code class="highlighter-rouge">@wip</code> （工作进行中）标签标记你未完成的场景。这些场景不纳入考虑，且不标记为测试失败。当完成一个未完成场景且功能测试通过时，为了把此场景加至测试套件里，应该移除 <code class="highlighter-rouge">@wip</code> 标签。</li>
  <li>配置你的缺省配置文件，排除掉标记为 <code class="highlighter-rouge">@javascript</code> 的场景。它们使用浏览器来测试，推荐停用它们来增加一般场景的执行速度。</li>
  <li>替标记著 <code class="highlighter-rouge">@javascript</code> 的场景配置另一个配置文件。
    <ul>
      <li>
        <p>配置文件可在 <code class="highlighter-rouge">cucumber.yml</code> 文件里配置。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
# 配置文件的定义：
profile_name: --tags @tag_name
```
</code></pre></div>        </div>
      </li>
      <li>
        <p>带指令运行一个配置文件：</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```
cucumber -p profile_name
```
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>若使用 <a href="http://fabricationgem.org/">fabrication</a> 来替换假数据 (fixtures)，使用预定义的 <a href="http://fabricationgem.org/#!cucumber-steps">fabrication steps</a>。</li>
  <li>不要使用旧版的 <code class="highlighter-rouge">web_steps.rb</code> 步骤定义！<a href="http://aslakhellesoy.com/post/11055981222/the-training-wheels-came-off">最新版 Cucumber 已移除 web steps</a>，使用它们导致冗赘的场景，而且它并没有正确地反映出应用的领域。</li>
  <li>当检查一元素的可视文字时，检查元素的文字而不是检查 id。这样可以查出 i18n 的问题。</li>
  <li>
    <p>给同种类对象创建不同的功能特色：</p>

    <pre><code class="language-Ruby">  # 差
  Feature: Articles
  # ... 功能实作 ...

  # 好
  Feature: Article Editing
  # ... 功能实作 ...

  Feature: Article Publishing
  # ... 功能实作 ...

  Feature: Article Search
  # ... 功能实作 ...

</code></pre>
  </li>
  <li>每一个功能有三个主要成分：
    <ul>
      <li>Title</li>
      <li>Narrative - 简短说明这个特色关于什么。</li>
      <li>Acceptance criteria - 每个由独立步骤组成的一套场景。</li>
    </ul>
  </li>
  <li>
    <p>最常见的格式称为 Connextra 格式。</p>

    <pre><code class="language-Ruby">  In order to [benefit] ...
  A [stakeholder]...
  Wants to [feature] ...
</code></pre>
  </li>
</ul>

<p>这是最常见但不是要求的格式，叙述可以是依赖功能复杂度的任何文字。</p>

<ul>
  <li>
    <p>自由地使用场景概述使你的场景备作它用 (keep your scenarios DRY)。</p>

    <pre><code class="language-Ruby">  Scenario Outline: User cannot register with invalid e-mail
    When I try to register with an email "&lt;email&gt;"
    Then I should see the error message "&lt;error&gt;"

  Examples:
    |email         |error                 |
    |              |The e-mail is required|
    |invalid email |is not a valid e-mail |
</code></pre>
  </li>
  <li>场景的步骤放在 <code class="highlighter-rouge">step_definitions</code> 目录下的 <code class="highlighter-rouge">.rb</code> 文件。步骤文件命名惯例为 <code class="highlighter-rouge">[description]_steps.rb</code>。步骤根据不同的标准放在不同的文件里。每一个功能可能有一个步骤文件 (<code class="highlighter-rouge">home_page_steps.rb</code>)
。也可能给每个特定对象的功能，建一个步骤文件 (<code class="highlighter-rouge">articles_steps.rb</code>)。</li>
  <li>
    <p>使用多行步骤参数来避免重复</p>

    <pre><code class="language-Ruby">  场景: User profile
    Given I am logged in as a user "John Doe" with an e-mail "user@test.com"
    When I go to my profile
    Then I should see the following information:
      |First name|John         |
      |Last name |Doe          |
      |E-mail    |user@test.com|

  # 步骤:
  Then /^I should see the following information:$/ do |table|
    table.raw.each do |field, value|
      find_field(field).value.should =~ /#{value}/
    end
  end
</code></pre>
  </li>
  <li>
    <p>使用复合步骤使场景备作它用 (Keep your scenarios DRY)</p>

    <pre><code class="language-Ruby">  # ...
  When I subscribe for news from the category "Technical News"
  # ...

  # 步骤:
  When /^I subscribe for news from the category "([^"]*)"$/ do |category|
    steps %Q{
      When I go to the news categories page
      And I select the category #{category}
      And I click the button "Subscribe for this category"
      And I confirm the subscription
    }
  end
</code></pre>
  </li>
  <li>总是使用 Capybara 否定匹配来取代正面情况搭配 should_not，它们会在给定的超时时重试匹配，允许你测试 ajax 动作。 见 <a href="https://github.com/jnicklas/capybara">Capybara 的 读我文件</a>获得更多说明。</li>
</ul>

<h2 id="rspec">RSpec</h2>

<ul>
  <li>
    <p>一个例子仅用一个期望值。</p>

    <pre><code class="language-Ruby">  # 差
  describe ArticlesController do
    #...

    describe 'GET new' do
      it 'assigns new article and renders the new article template' do
        get :new
        assigns[:article].should be_a_new Article
        response.should render_template :new
      end
    end

    # ...
  end

  # 好
  describe ArticlesController do
    #...

    describe 'GET new' do
      it 'assigns a new article' do
        get :new
        assigns[:article].should be_a_new Article
      end

      it 'renders the new article template' do
        get :new
        response.should render_template :new
      end
    end

  end
</code></pre>
  </li>
  <li>大量使用 <code class="highlighter-rouge">descibe</code> 及 <code class="highlighter-rouge">context</code> 。</li>
  <li>如下地替 <code class="highlighter-rouge">describe</code> 区块命名：
    <ul>
      <li>非方法使用 “description”</li>
      <li>实例方法使用井字号 “#method”</li>
      <li>
        <p>类别方法使用点 “.method”</p>

        <pre><code class="language-Ruby">class Article
  def summary
    #...
  end

  def self.latest
    #...
  end
end

# the spec...
describe Article do
  describe '#summary' do
    #...
  end

  describe '.latest' do
    #...
  end
end
</code></pre>
      </li>
    </ul>
  </li>
  <li>
    <p>使用 <a href="http://fabricationgem.org/">fabricators</a> 来创建测试对象。</p>
  </li>
  <li>
    <p>大量使用 mocks 与 stubs。</p>

    <pre><code class="language-Ruby">  # mocking 一个模型
  article = mock_model(Article)

  # stubbing 一个方法
  Article.stub(:find).with(article.id).and_return(article)
</code></pre>
  </li>
  <li>
    <p>当 mocking 一个模型时，使用 <code class="highlighter-rouge">as_null_object</code> 方法。它告诉输出仅监听我们预期的讯息，并忽略其它的讯息。</p>

    <pre><code class="language-Ruby">  article = mock_model(Article).as_null_object
</code></pre>
  </li>
  <li>
    <p>使用 <code class="highlighter-rouge">let</code> 区块而不是 <code class="highlighter-rouge">before(:each)</code> 区块替 spec 例子创建数据。<code class="highlighter-rouge">let</code> 区块会被懒惰求值。</p>

    <pre><code class="language-Ruby">  # 使用这个：
  let(:article) { Fabricate(:article) }

  # ... 而不是这个：
  before(:each) { @article = Fabricate(:article) }
</code></pre>
  </li>
  <li>
    <p>当可能时，使用 <code class="highlighter-rouge">subject</code>。</p>

    <pre><code class="language-Ruby">  describe Article do
    subject { Fabricate(:article) }

    it 'is not published on creation' do
      subject.should_not be_published
    end
  end
</code></pre>
  </li>
  <li>
    <p>如果可能的话，使用 <code class="highlighter-rouge">specify</code>。它是 <code class="highlighter-rouge">it</code> 的同义词，但在没 docstring 的情况下可读性更高。</p>

    <pre><code class="language-Ruby">  # 差
  describe Article do
    before { @article = Fabricate(:article) }

    it 'is not published on creation' do
      @article.should_not be_published
    end
  end

  # 好
  describe Article do
    let(:article) { Fabricate(:article) }
    specify { article.should_not be_published }
  end
</code></pre>
  </li>
  <li>
    <p>当可能时，使用 <code class="highlighter-rouge">its</code> 。</p>

    <pre><code class="language-Ruby">  # 差
  describe Article do
    subject { Fabricate(:article) }

    it 'has the current date as creation date' do
      subject.creation_date.should == Date.today
    end
  end

  # 好
  describe Article do
    subject { Fabricate(:article) }
    its(:creation_date) { should == Date.today }
  end
</code></pre>
  </li>
  <li>
    <p>Use <code class="highlighter-rouge">shared_examples</code> if you want to create a spec group that can be shared by many other tests.</p>

    <p>```Ruby
 # bad
  describe Array do
    subject { Array.new [7, 2, 4] }</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context "initialized with 3 items" do
  its(:size) { should eq(3) }
end   end
</code></pre></div>    </div>

    <p>describe Set do
    subject { Set.new [7, 2, 4] }</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context "initialized with 3 items" do
  its(:size) { should eq(3) }
end   end
</code></pre></div>    </div>

    <p>#good
  shared_examples “a collection” do
    subject { described_class.new([7, 2, 4]) }</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context "initialized with 3 items" do
  its(:size) { should eq(3) }
end   end
</code></pre></div>    </div>

    <p>describe Array do
    it_behaves_like “a collection”
  end</p>

    <p>describe Set do
    it_behaves_like “a collection”
  end</p>
  </li>
</ul>

<h3 id="视图-1">视图</h3>

<ul>
  <li>视图测试的目录结构要与 <code class="highlighter-rouge">app/views</code> 之中的相符。 举例来说，在 <code class="highlighter-rouge">app/views/users</code> 视图被放在 <code class="highlighter-rouge">spec/views/users</code>。</li>
  <li>视图测试的命名惯例是添加 <code class="highlighter-rouge">_spec.rb</code> 至视图名字之后，举例来说，视图 <code class="highlighter-rouge">_form.html.haml</code> 有一个对应的测试叫做 <code class="highlighter-rouge">_form.html.haml_spec.rb</code>。</li>
  <li>每个视图测试文件都需要 <code class="highlighter-rouge">spec_helper.rb</code>。</li>
  <li>
    <p>外部描述区块使用不含 <code class="highlighter-rouge">app/views</code> 部分的视图路径。 <code class="highlighter-rouge">render</code> 方法没有传入参数时，是这么使用的。</p>

    <pre><code class="language-Ruby">  # spec/views/articles/new.html.haml_spec.rb
  require 'spec_helper'

  describe 'articles/new.html.haml' do
    # ...
  end
</code></pre>
  </li>
  <li>永远在视图测试来 mock 模型。视图的目的只是显示信息。</li>
  <li>
    <p><code class="highlighter-rouge">assign</code> 方法提供由控制器提供视图使用的实例变量(instance variable)。</p>

    <pre><code class="language-Ruby">  # spec/views/articles/edit.html.haml_spec.rb
  describe 'articles/edit.html.haml' do
  it 'renders the form for a new article creation' do
    assign(
      :article,
      mock_model(Article).as_new_record.as_null_object
    )
    render
    rendered.should have_selector('form',
      method: 'post',
      action: articles_path
    ) do |form|
      form.should have_selector('input', type: 'submit')
    end
  end
</code></pre>
  </li>
  <li>
    <p>偏好 capybara 否定情况选择器，胜于搭配正面情况的 should_not 。</p>

    <pre><code class="language-Ruby">  # 差
  page.should_not have_selector('input', type: 'submit')
  page.should_not have_xpath('tr')

  # 好
  page.should have_no_selector('input', type: 'submit')
  page.should have_no_xpath('tr')
</code></pre>
  </li>
  <li>
    <p>当一个视图使用 helper 方法时，这些方法需要被 stubbed。Stubbing 这些 helper 方法是在 <code class="highlighter-rouge">template</code> 完成的：</p>

    <pre><code class="language-Ruby">  # app/helpers/articles_helper.rb
  class ArticlesHelper
    def formatted_date(date)
      # ...
    end
  end

  # app/views/articles/show.html.haml
  = "Published at: #{formatted_date(@article.published_at)}"

  # spec/views/articles/show.html.haml_spec.rb
  describe 'articles/show.html.haml' do
    it 'displays the formatted date of article publishing' do
      article = mock_model(Article, published_at: Date.new(2012, 01, 01))
      assign(:article, article)

      template.stub(:formatted_date).with(article.published_at).and_return('01.01.2012')

      render
      rendered.should have_content('Published at: 01.01.2012')
    end
  end
</code></pre>
  </li>
  <li>在 <code class="highlighter-rouge">spec/helpers</code> 目录的 helper specs 是与视图 specs 分开的。</li>
</ul>

<h3 id="控制器-1">控制器</h3>

<ul>
  <li>Mock 模型及 stub 他们的方法。测试控制器时不应依赖建模。</li>
  <li>仅测试控制器需负责的行为：
    <ul>
      <li>执行特定的方法</li>
      <li>从动作返回的数据 - assigns, 等等。</li>
      <li>
        <p>从动作返回的结果 - template render, redirect, 等等。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```Ruby
# 常用的控制器 spec 示例
# spec/controllers/articles_controller_spec.rb
# 我们只对控制器应执行的动作感兴趣
# 所以我们 mock 模型及 stub 它的方法
# 并且专注在控制器该做的事情上

describe ArticlesController do
  # 模型将会在测试中被所有控制器的方法所使用
  let(:article) { mock_model(Article) }

  describe 'POST create' do
    before { Article.stub(:new).and_return(article) }

    it 'creates a new article with the given attributes' do
      Article.should_receive(:new).with(title: 'The New Article Title').and_return(article)
      post :create, message: { title: 'The New Article Title' }
    end

    it 'saves the article' do
      article.should_receive(:save)
      post :create
    end

    it 'redirects to the Articles index' do
      article.stub(:save)
      post :create
      response.should redirect_to(action: 'index')
    end
  end
end
```
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>当控制器根据不同参数有不同行为时，使用 context。</p>

    <pre><code class="language-Ruby">  # 一个在控制器中使用 context 的典型例子是，对象正确保存时，使用创建，保存失败时更新。

  describe ArticlesController do
    let(:article) { mock_model(Article) }

    describe 'POST create' do
      before { Article.stub(:new).and_return(article) }

      it 'creates a new article with the given attributes' do
        Article.should_receive(:new).with(title: 'The New Article Title').and_return(article)
        post :create, article: { title: 'The New Article Title' }
      end

      it 'saves the article' do
        article.should_receive(:save)
        post :create
      end

      context 'when the article saves successfully' do
        before { article.stub(:save).and_return(true) }

        it 'sets a flash[:notice] message' do
          post :create
          flash[:notice].should eq('The article was saved successfully.')
        end

        it 'redirects to the Articles index' do
          post :create
          response.should redirect_to(action: 'index')
        end
      end

      context 'when the article fails to save' do
        before { article.stub(:save).and_return(false) }

        it 'assigns @article' do
          post :create
          assigns[:article].should be_eql(article)
        end

        it 're-renders the "new" template' do
          post :create
          response.should render_template('new')
        end
      end
    end
  end
</code></pre>
  </li>
</ul>

<h3 id="模型-1">模型</h3>

<ul>
  <li>不要在自己的测试里 mock 模型。</li>
  <li>使用捏造的东西来创建真的对象</li>
  <li>Mock 别的模型或子对象是可接受的。</li>
  <li>
    <p>在测试里建立所有例子的模型来避免重复。</p>

    <pre><code class="language-Ruby">  describe Article do
    let(:article) { Fabricate(:article) }
  end
</code></pre>
  </li>
  <li>
    <p>加入一个例子确保捏造的模型是可行的。</p>

    <pre><code class="language-Ruby">  describe Article do
    it 'is valid with valid attributes' do
      article.should be_valid
    end
  end
</code></pre>
  </li>
  <li>
    <p>当测试验证时，使用 <code class="highlighter-rouge">have(x).errors_on</code> 来指定要被验证的属性。使用 <code class="highlighter-rouge">be_valid</code> 不保证问题在目的的属性。</p>

    <pre><code class="language-Ruby">  # 差
  describe '#title' do
    it 'is required' do
      article.title = nil
      article.should_not be_valid
    end
  end

  # 偏好
  describe '#title' do
    it 'is required' do
      article.title = nil
      article.should have(1).error_on(:title)
    end
  end
</code></pre>
  </li>
  <li>
    <p>替每个有验证的属性加另一个 <code class="highlighter-rouge">describe</code>。</p>

    <pre><code class="language-Ruby">  describe Article do
    describe '#title' do
      it 'is required' do
        article.title = nil
        article.should have(1).error_on(:title)
      end
    end
  end
</code></pre>
  </li>
  <li>
    <p>当测试模型属性的独立性时，把其它对象命名为 <code class="highlighter-rouge">another_object</code>。</p>

    <pre><code class="language-Ruby">  describe Article do
    describe '#title' do
      it 'is unique' do
        another_article = Fabricate.build(:article, title: article.title)
        article.should have(1).error_on(:title)
      end
    end
  end
</code></pre>
  </li>
</ul>

<h3 id="mailers-1">Mailers</h3>

<ul>
  <li>在 Mailer 测试的模型应该要被 mock。 Mailer 不应依赖建模。</li>
  <li>Mailer 的测试应该确认如下：
    <ul>
      <li>这个 subject 是正确的</li>
      <li>这个 receiver e-mail 是正确的</li>
      <li>这个 e-mail 寄送至对的邮件地址</li>
      <li>
        <p>这个 e-mail 包含了需要的信息</p>

        <pre><code class="language-Ruby"> describe SubscriberMailer
   let(:subscriber) { mock_model(Subscription, email: 'johndoe@test.com', name: 'John Doe') }

   describe 'successful registration email' do
     subject { SubscriptionMailer.successful_registration_email(subscriber) }

     its(:subject) { should == 'Successful Registration!' }
     its(:from) { should == ['info@your_site.com'] }
     its(:to) { should == [subscriber.email] }

     it 'contains the subscriber name' do
       subject.body.encoded.should match(subscriber.name)
     end
   end
 end
</code></pre>
      </li>
    </ul>
  </li>
</ul>

<h3 id="uploaders">Uploaders</h3>

<ul>
  <li>
    <p>我们如何测试上传器是否正确地调整大小。这里是一个 <a href="https://github.com/jnicklas/carrierwave">carrierwave</a> 图片上传器的示例 spec：</p>

    <pre><code class="language-Ruby">  # rspec/uploaders/person_avatar_uploader_spec.rb
  require 'spec_helper'
  require 'carrierwave/test/matchers'

  describe PersonAvatarUploader do
    include CarrierWave::Test::Matchers

    # 在执行例子前启用图片处理
    before(:all) do
      UserAvatarUploader.enable_processing = true
    end

    # 创建一个新的 uploader。模型被模仿为不依赖建模时的上传及调整图片。
    before(:each) do
      @uploader = PersonAvatarUploader.new(mock_model(Person).as_null_object)
      @uploader.store!(File.open(path_to_file))
    end

    # 执行完例子时停用图片处理
    after(:all) do
      UserAvatarUploader.enable_processing = false
    end

    # 测试图片是否不比给定的维度长
    context 'the default version' do
      it 'scales down an image to be no larger than 256 by 256 pixels' do
        @uploader.should be_no_larger_than(256, 256)
      end
    end

    # 测试图片是否有确切的维度
    context 'the thumb version' do
      it 'scales down an image to be exactly 64 by 64 pixels' do
        @uploader.thumb.should have_dimensions(64, 64)
      end
    end
  end
</code></pre>
  </li>
</ul>

<h1 id="延伸阅读">延伸阅读</h1>

<p>有几个绝妙讲述 Rails 风格的资源，若有闲暇时应当考虑延伸阅读：</p>

<ul>
  <li><a href="http://www.amazon.com/Rails-Way-Addison-Wesley-Professional-Ruby/dp/0321601661">The Rails 3 Way</a></li>
  <li><a href="http://guides.rubyonrails.org/">Ruby on Rails Guides</a></li>
  <li><a href="http://pragprog.com/book/achbd/the-rspec-book">The RSpec Book</a></li>
  <li><a href="http://pragprog.com/book/hwcuc/the-cucumber-book">The Cucumber Book</a></li>
  <li><a href="https://leanpub.com/everydayrailsrspec">Everyday Rails Testing with RSpec</a></li>
</ul>

<h1 id="贡献">贡献</h1>

<p>在本指南所写的每个东西都不是定案。这只是我渴望想与同样对 Rails 编码风格有兴趣的大家一起工作，以致于最终我们可以替整个 Ruby 社群创造一个有益的资源。</p>

<p>欢迎开票或发送一个带有改进的更新请求。在此提前感谢你的帮助！</p>

<h1 id="授权">授权</h1>

<p><img src="http://i.creativecommons.org/l/by/3.0/88x31.png" alt="Creative Commons License" />
This work is licensed under a <a href="http://creativecommons.org/licenses/by/3.0/deed.zh">Creative Commons Attribution 3.0 Unported License</a></p>

<h1 id="口耳相传">口耳相传</h1>

<p>一份社群驱动的风格指南，对一个社群来说，只是让人知道有这个社群。微博转发这份指南，分享给你的朋友或同事。我们得到的每个注解、建议或意见都可以让这份指南变得更好一点。而我们想要拥有的是最好的指南，不是吗？</p>

<p>共勉之,<br />
<a href="https://twitter.com/bbatsov">Bozhidar</a></p>

          </article>
          <hr class="boundary">
        </div>

        <div class="pad-min"></div>
        <div id="post-comment" class="sheet post">
            <!--PC和WAP自适应版-->
<div id="SOHUCS" sid="/2015-11-17/rails-style-guide/" ></div>

<script type="text/javascript">
(function(){
var appid = "cysX5sziD";
var conf = "prod_45285c7173354294675fbce39f863858";
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>


        </div>

    </div>

    <div class="content-navigation col-lg-3">
      <div class="shadow-bottom-center" >
        <div class="content-navigation-toc">
            <div class="content-navigation-header">
                <span class="octicon octicon-list-unordered"></span>&nbsp;Toc
            </div>
            <div class="content-navigation-list toc"></div>
        </div>
        <div class="content-navigation-tag">
            <div class="content-navigation-header">
                <span class="octicon octicon-list-unordered"></span>&nbsp;Tags
            </div>
            <div class="content-navigation-list">
                <ul>
                    
                    <li>
                        <a href="http://localhost:4000/tags#rails"><span class="octicon octicon-tag"></span>&nbsp;rails</a>
                    </li>
                    
                    <li>
                        <a href="http://localhost:4000/tags#guide"><span class="octicon octicon-tag"></span>&nbsp;guide</a>
                    </li>
                    
                </ul>
            </div>
        </div>

        <div class="content-navigation-related">
            <div class="content-navigation-header">
                <span class="octicon octicon-list-unordered"></span>&nbsp;Related
            </div>
            <div class="content-navigation-list">
                <ul>
                    

                    

                    
                        
                            <li>
                                <a href="http://localhost:4000/2017-12-13/Ruby-Errors-Record/">Ruby 报错记录</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2017-10-29/open-local-gem-server/">Rails 离线 Bundle</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2017-10-25/rails-offline-bundle/">Rails 离线 Bundle</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2017-08-04/rails-search-many-fields/">解决 Where 多条件查询</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2017-08-02/install-nokogiri-error/">安装 nokogiri gem 报错</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2017-07-18/activerecord-history/">常用方法记录</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2017-04-12/activerecord-with-mysql/">Activerecord 连 MySQL</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2016-11-22/rails-migration-execute-sql/">Migration 执行 SQL 语句</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2016-11-22/Use-Database-View-In-Rails-Development/">在 Rails 项目开发过程中使用视图</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2016-11-01/rails-with-uuid/">Rails项目使用UUID</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2016-09-18/Rails5-actioncable-deploy/">actioncable部署记录</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2016-03-29/rails-flash-angularjs/">在 AngularJS 中显示 Rails Flash中消息</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2016-03-02/rails-Unscoped-Scope/">rails unscoped 作用域位置的影响</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2015-11-17/ruby-style-guide/">Ruby Style Guide</a>
                            </li>
                        
                            <li>
                                <a href="http://localhost:4000/2015-11-11/Rails-App-Deploy-To-Heroku/">rails 应用部署到 heroku</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
      </div>
    </div>
</div>
    </div>

    <div class="page-scrollTop" data-toggle="tooltip" data-placement="top" title="Top">
        <a href="javascript:void(0);">
            <div class="arrow"></div>
            <div class="stick"></div>
        </a>
    </div>
</div>

<footer  class="footnote footnote-tiffany">
	<div class="container">
		<div class="summary">
			总访问<span id="busuanzi_value_site_pv"></span>次，访客<span id="busuanzi_value_site_uv"></span>人次，本页总阅读<span id="busuanzi_value_page_pv"></span>次
		</div>
		</line>
		<a class="foot-item" href="mailto:cxhyun@126.com" target="_blank"><span class="octicon octicon-mail"></span></a>
		<a class="foot-item" href="https://github.com/cheenwe" target="_blank"><span class="octicon octicon-mark-github"></span></a>
		<a class="foot-item" href="http://localhost:4000/feed.xml" target="_blank"><span class="octicon octicon-rss"></span></a>
		<a class="foot-item" href="http://localhost:4000/link/"><span class="octicon octicon-link-external"></span></a>
		&nbsp;
		<a href="http://localhost:4000/about/"><span class="word-keep">&copy;Cheenwe</span></a>
		<a href="http://www.miitbeian.gov.cn/" target="_blank">豫ICP备16011691号</a>

	</div>
</footer>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/static/js/lunr.min.js"></script>
<script src="/static/js/search.js"></script>

<script type="text/javascript" src="http://localhost:4000/static/js/script.js"></script>
<script type="text/javascript" src="http://localhost:4000/static/js/post.js"></script>

<script type="text/javascript" src="http://localhost:4000/static/js/toc.js"></script>




    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?53d63f40f6eef2f51c5cf14443efe386";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


</body>
</html>
